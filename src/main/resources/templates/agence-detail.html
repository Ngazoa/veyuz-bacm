<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml"
      th:replace="~{layout/layout::main-fragment(
        ~{::title},
        ~{:: #others-static-ressource},
        ~{:: #main-content},
        ~{:: #others-js}
      )}">

<title>Gestion des Agences</title>

<th:block id="others-static-ressource"></th:block>

<div id="main-content">
    <div class="row">
        <div class="row">
            <div class="col-sm-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Clients</h5>
                            </div>

                            <div class="col-auto">
                                <div class="stat text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                         fill="none" stroke="currentColor"
                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                         class="feather feather-compass align-middle"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3" th:text="${clients}"></h1>
                        <div class="mb-0">
                          <a th:href="@{/clients}">  <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i>Plus... </span></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Total Transactions</h5>
                            </div>

                            <div class="col-auto">
                                <div class="stat text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                         stroke-linejoin="round" class="feather feather-shopping-bag align-middle"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3" th:text="${transactionsCount}">2.542</h1>
                        <div class="mb-0">
                            <a th:href="@{/transactions-{agence}(agence=${agence.id})}">  <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i>Plus... </span></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Transmis pour Debit</h5>
                            </div>

                            <div class="col-auto">
                                <div class="stat text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-activity align-middle"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3" th:text="${transactionApur}">16.300</h1>
                        <div class="mb-0">
                            <a th:href="@{/transactions-state/{agence}/{status}(agence=${agence.id},status='validated')}">  <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i>Plus... </span></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Transac. en Attente</h5>
                            </div>

                            <div class="col-auto">
                                <div class="stat text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-cart align-middle"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3"th:text="${transactionWait}">$20.120</h1>
                        <div class="mb-0">
                            <a th:href="@{/transactions-state/{agence}/{status}(agence=${agence.id},status='waiting')}">  <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i>Plus... </span></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>







        <div class="card">

            <div class="card-header">
                <h5 class="card-title">
                    Liste des transactions - <span th:text="${agence !=null ? agence.label:' / '}"></span>
                </h5>
                <div th:if="${#authorization.expression('hasRole(''ROLE_SUPERADMIN'')')}">

                    <a th:if="${withStatus == null}" th:href="@{/{id}-export/transaction(id=${banque.id}, type='excel')}">
                        <i class="fas fa-excel"></i> exporter sur excel
                    </a>
                    <a th:unless="${withStatus == null}" th:href="@{/{id}-export/transaction(id=${banque.id}, type='excel', statut=${withStatus})}">
                        <i class="fas fa-excel"></i> exporter sur excel
                    </a>
                </div>
                <h6 class="card-subtitle text-muted"></h6>
            </div>
            <div class="card-body">
                <table id="datatables-reponsive" class="table table-striped" style="width:100%">
                    <thead>
                    <tr>
                        <th>Reference</th>
                        <th>Type</th>
                        <th>Client</th>
                        <th>Beneficiaire</th>
                        <th>Date Creat</th>
                        <th>Montant</th>
                        <th>Agence</th>
                        <th>Initiateur</th>
                        <th>Statut</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="transaction, state : ${transactions}">

                        <td th:utext="${transaction.reference}"></td>
                        <td th:utext="${transaction.typeDeTransaction.name}"></td>
                        <td th:utext="${transaction.client.denomination}"></td>
                        <td th:utext="${transaction.beneficiaire.name}"></td>
                        <td th:text="${transaction.dateCreation}" />
                        <td class="montant_format" th:text="${transaction.montant}"></td>
                        <td th:text="${transaction.client.agence != null ? transaction.client.agence.label : ''}"></td>
                        <td th:if="${transaction.appUser!=null}" th:text="${transaction.appUser.nom}"></td>
                        <td th:if="${transaction.appUser==null}">/</td>
                        <td>
                            <span th:if="${transaction.statut == 0}" class="badge bg-primary">En attente</span>
                            <span th:if="${transaction.statut == 1}" class="badge bg-info"><i class="fas fa-folder-open"></i>Traitee TDM</span>
                            <span th:if="${transaction.statut == 2}" class="badge bg-primary">Validée TDC</span>
                            <span th:if="${transaction.statut == 7}" class="badge bg-secondary">Traitée TOPsM</span>
                            <span th:if="${transaction.statut == 8}" class="badge bg-info">Validé TOPsC</span>
                            <span th:if="${transaction.statut == 3}" class="badge bg-success"><i class="fas fa-check"></i> Validée</span>
                            <span th:if="${transaction.statut == -1}" class="badge bg-danger"><i class="fas fa-times"></i> Rejetée</span>
                            <span th:if="${transaction.statut == 9}" class="badge bg-warning"><i class="fas fa-times"></i> Treasury</span>
                            <span th:if="${transaction.statut == 4 or transaction.statut == 5}" class="badge bg-warning"><i class="fas fa-undo"></i> Renvoyée</span>

                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select
                                </button>
                                <div class="dropdown-menu" style="">
                                    <a  class="dropdown-item" th:href="@{/transaction-{id}/details(id=${transaction.id})}">Afficher les details</a>
                                    <div class="dropdown-divider"></div>
                                    <th:block th:if="${#authorization.expression('hasRole(''ROLE_CLIENT'')')}">
                                        <a th:if="${transaction.statut <1}" class="dropdown-item delete-transaction" th:href="@{/delete-transaction-{id}(id=${transaction.id})}">Supprimer la transaction</a>
                                    </th:block>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <nav id="pagination" th:if="${nbPages != null and nbPages > 1 }" th:data-pages="${nbPages}" th:data-uri="${uri}" th:data-current="${currentPage}" aria-label="Page navigation example">
                    <div th:replace="pagination::pagination"></div>
                </nav>
            </div>

        </div>
    </div>

</div>

<th:block id="others-js">

    <script>
            $('.show-benef-transactions').on("click", function(e){
                e.preventDefault();
                $.ajax({
                    url: $(this).prop("href"),
                    type: "GET",
                    dataType: "JSON",
                    beforeSend: function() {
                        $("#transactions-benef").html('<div class="spinner-border text-secondary me-2" role="status"><span class="visually-hidden">Loading...</span></div>');
                        $("#sizedModalLg").modal('show');
                    },
                    success: function(response) {
                        if (!response.hasError) {
                            $("#transactions-benef").html(response.transactions);
                        }
                        else {
                            $("#transactions-benef").html(response.message);
                        }
                    },
                    error: function() {
                        $("#sizedModalLg").modal('hidde');
                    }
                })
            })
        </script>

</th:block>
</html>